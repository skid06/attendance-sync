services:
  attendance-sync:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: attendance-sync
    restart: unless-stopped

    # Network mode: Use host network to access devices on local network
    network_mode: host

    # Environment variables (override .env file values if needed)
    environment:
      - APP_ENV=${APP_ENV:-production}
      - APP_DEBUG=${APP_DEBUG:-false}
      - ATTENDANCE_DRIVER=${ATTENDANCE_DRIVER:-zkteco}
      - ATTENDANCE_DEVICE_IP=${ATTENDANCE_DEVICE_IP:-192.168.1.201}
      - ATTENDANCE_DEVICE_PORT=${ATTENDANCE_DEVICE_PORT:-4370}
      - ATTENDANCE_API_URL=${ATTENDANCE_API_URL}
      - ATTENDANCE_API_KEY=${ATTENDANCE_API_KEY}
      - ATTENDANCE_API_TIMEOUT=${ATTENDANCE_API_TIMEOUT:-30}
      - ATTENDANCE_SYNC_BATCH_SIZE=${ATTENDANCE_SYNC_BATCH_SIZE:-100}
      - ATTENDANCE_AUTO_CLEAR=${ATTENDANCE_AUTO_CLEAR:-false}
      - ATTENDANCE_RETRY_FAILED=${ATTENDANCE_RETRY_FAILED:-true}
      - ATTENDANCE_MAX_RETRIES=${ATTENDANCE_MAX_RETRIES:-3}
      - ATTENDANCE_DEBUG=${ATTENDANCE_DEBUG:-false}

    # Mount volumes for persistence
    volumes:
      # Persist SQLite database
      - ./database/database.sqlite:/app/database/database.sqlite
      # Persist logs
      - ./storage/logs:/app/storage/logs
      # Mount .env file
      - ./.env:/app/.env:ro

    # Command to run (can be overridden)
    command: php artisan attendance:sync --clear

    # Health check
    healthcheck:
      test: ["CMD", "php", "artisan", "attendance:sync", "--test"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Optional: Scheduled sync service (runs every hour)
  attendance-sync-scheduled:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: attendance-sync-scheduled
    restart: unless-stopped

    network_mode: host

    environment:
      - APP_ENV=${APP_ENV:-production}
      - APP_DEBUG=${APP_DEBUG:-false}
      - ATTENDANCE_DRIVER=${ATTENDANCE_DRIVER:-zkteco}
      - ATTENDANCE_DEVICE_IP=${ATTENDANCE_DEVICE_IP:-192.168.1.201}
      - ATTENDANCE_DEVICE_PORT=${ATTENDANCE_DEVICE_PORT:-4370}
      - ATTENDANCE_API_URL=${ATTENDANCE_API_URL}
      - ATTENDANCE_API_KEY=${ATTENDANCE_API_KEY}
      - ATTENDANCE_API_TIMEOUT=${ATTENDANCE_API_TIMEOUT:-30}
      - ATTENDANCE_SYNC_BATCH_SIZE=${ATTENDANCE_SYNC_BATCH_SIZE:-100}
      - ATTENDANCE_AUTO_CLEAR=${ATTENDANCE_AUTO_CLEAR:-false}
      - ATTENDANCE_RETRY_FAILED=${ATTENDANCE_RETRY_FAILED:-true}
      - ATTENDANCE_MAX_RETRIES=${ATTENDANCE_MAX_RETRIES:-3}
      - ATTENDANCE_DEBUG=${ATTENDANCE_DEBUG:-false}

    volumes:
      - ./database/database.sqlite:/app/database/database.sqlite
      - ./storage/logs:/app/storage/logs
      - ./.env:/app/.env:ro

    # Run sync every hour using a shell loop
    command: >
      sh -c "while true; do
        echo '[$(date)] Running scheduled sync...'
        php artisan attendance:sync --clear
        echo '[$(date)] Sync completed. Waiting 1 hour...'
        sleep 3600
      done"

    profiles:
      - scheduled  # Only start if explicitly enabled with --profile scheduled

  # Optional: One-time test service
  attendance-test:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: attendance-test

    network_mode: host

    environment:
      - APP_ENV=${APP_ENV:-production}
      - ATTENDANCE_DRIVER=${ATTENDANCE_DRIVER:-zkteco}
      - ATTENDANCE_DEVICE_IP=${ATTENDANCE_DEVICE_IP:-192.168.1.201}
      - ATTENDANCE_DEVICE_PORT=${ATTENDANCE_DEVICE_PORT:-4370}
      - ATTENDANCE_API_URL=${ATTENDANCE_API_URL}
      - ATTENDANCE_API_KEY=${ATTENDANCE_API_KEY}

    volumes:
      - ./.env:/app/.env:ro

    command: php artisan attendance:sync --test

    profiles:
      - test  # Only start if explicitly enabled with --profile test
